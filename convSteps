set -e 
trainfile=/iesl/canvas/beroth/tac/data/merge_2013.tab
devfile=/iesl/canvas/beroth/tac/runs/run20140314/candidates
vocabThresh=25

tb=`basename $trainfile`
db=`basename $devfile`

out=$PWD/convDataFlip
flip=1
ot=$out/$tb
otc=$out/$tb.cross
od=$out/$db

shuf $trainfile > $ot.shuff
shuf $devfile > $od.shuff

crossLen=`wc -l $ot.shuff | cut -d" " -f1 | xargs -ifoo expr foo / 6`

tail -n $crossLen $ot.shuff > $otc.shuff

#format: <relname>\t<l/r>\t<string>
#here, l/r=1 if arg1 comes first and 0 if they are swapped
for f in $ot $otc $od
do
	perl sliceArgStringAppend.pl $f.shuff relTypes.txt $flip > $f.argstring
done


cut -f3 $ot.argstring | tr ' ' '\n' | sort | uniq -c | sort -n -r  | sed 's|^\s*||' | perl -ne '$o = $_; /(\d*)/;  if($1 > 10){print $o;}'> $out/vocab.counts.txt
cut -d" " -f2 $out/vocab.counts.txt > $out/vocab.txt
echo "<unk>" >> $out/vocab.txt

cut -f1 $ot.argstring  | sort -u > $out/labelMap.txt
if [ "$flip" == 0 ]; then
   cat $out/labelMap.txt.tmp  | sed 's|$|-reverse|' >> $out/labelMap.txt
fi

for f in $ot $otc $od
do
	perl mapToInts.pl $f.argstring  $out/vocab.txt $out/labelMap.txt $flip > $f.argInt
done


mkdir -p $out/trainSplit/
mkdir -p $out/devSplit/
mkdir -p $out/trainCrossSplit/

perl splitByLength.pl $ot.argInt $ot.shuff $out/trainSplit/train.
perl splitByLength.pl $otc.argInt $otc.shuff $out/trainCrossSplit/trainCross.
perl splitByLength.pl $od.argInt $od.shuff $out/devSplit/dev.

for f in $out/{train,dev,trainCross}Split/*.int.txt
do 
   outfile=`echo $f | sed 's|.txt$|.torch|'`
   len=`basename $f .int.txt| sed 's|.*\.-||'`
   wc -l $f
   echo    th ../NLPConv/seq2torch.lua -file $f -len $len -out $outfile
   th ../NLPConv/seq2torch.lua -file $f -len $len -out $outfile
done



for name in dev trainCross
do
list=$out/paired.$name.FileList.txt
rm -f $list
for f in $out/${name}Split/$name.-{3,4,5,6,7,8,9,10,11}.string.txt
do
   outfile=`echo $f | sed 's|.txt$|.lhs|'`
   torchfile=`echo $f | sed 's|string.txt$|int.torch|'`   
   cat $f | cut -f1-8 > $outfile
   echo $torchfile $outfile >> $list
done


done

