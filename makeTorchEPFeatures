d=runs/run020815/
outdir=./processedData
ngram_ext=ngram_directed,skip_exact

singleSentenceMode=true

for set in train dev
do
	for ext in $ngram_ext intertext intertext_short
	do

		feat=$d/$set.$ext.ss-$singleSentenceMode.feats
		echo aggregating $feat
		perl aggregateByEP.pl $feat | grep -v -e '\s&&&$' > $feat.EP
#		perl aggregateByEP.pl $feat | grep -v -e '\s&&&$' | sed 's|per:employee_of|per:employee_or_member_of|' | sed 's|per:member_of|per:employee_or_member_of|'  > $feat.EP
	done
done


labelList=/tmp/labels

set=train
ext=$ngram_ext

cut -f2 $d/$set.$ext.ss-$singleSentenceMode.feats | sort -u > $labelList
num=`wc -l $labelList | cut -d" " -f1`
seq 1 $num > $labelList.num
paste $labelList $labelList.num > $d/labelMap.txt


for set in train dev
do
        for ext in $ngram_ext intertext intertext_short
        do

                feat=$d/$set.$ext.ss-$singleSentenceMode.feats

		cut -f2,9 $feat.EP  > $feat.mi.str
		perl mapLabels.perl $d/labelMap.txt  $feat.mi.str | perl -pne  's|^(\S+ )\+1 |$1|'  > $feat.mi
		cut -f1-8 $feat > $feat.lhs
        done
done

ext=$ngram_ext
for set in train dev
do
	feat=$d/$set.$ext.ss-$singleSentenceMode.feats
	cp $feat.mi $feat.mi.collapse
	cp $feat.EP $feat.EP.collapse
        cut -f1-8 $feat.EP.collapse > $feat.EP.collapse.lhs

done


for set in train dev
do
        for ext in  intertext intertext_short
        do
                feat=$d/$set.$ext.ss-$singleSentenceMode.feats
		perl CollapseFeatureCounts.pl $feat.mi $feat.EP  $feat.mi.collapse $feat.EP.collapse
		cut -f1-8 $feat.EP.collapse > $feat.EP.collapse.lhs
        done
done

